
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>IP over DNS Exploit - Grant Cohoe</title>
  <meta name="author" content="Grant Cohoe">

  
  <meta name="description" content="The Basics First let&#8217;s review how your traffic gets to it&#8217;s destination. You open up your favorite web browser and punch in &#8220;www. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cohoe.github.com/blog/2013/01/03/ip-over-dns-exploit/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/cohoe.css" type="text/css" rel="stylesheet">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Grant Cohoe" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37491721-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Grant Cohoe</a></h1>
  
    <h2>Cloud plumber, bit wrangler, solution engineer, hockey nut.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cohoe.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/skills">Skills</a></li>
  <li><a href="/about">About</a></li>
 <!-- <li><a href="/blog/archives">Archives</a></li>-->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">IP Over DNS Exploit</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-01-03T01:21:00-05:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>The Basics</h1>

<p>First let&#8217;s review how your traffic gets to it&#8217;s destination. You open up your favorite web browser and punch in &#8220;www.google.com&#8221;. Since your computer works with IP addresses, and not names (like people), you need to do a process of resolving the name. The Domain Name System (DNS) is the service that does this. Your ISP runs DNS servers, that are typically given to you in your DHCP lease. Your computer sends a query to this DNS server asking &#8220;what is the IP address of www.google.com&#8221;. Since your ISP does not have control over the &#8220;google.com&#8221; domain, the request is forwarded to another server. Eventually someone says &#8220;Hey! www.google.com is at 72.14.204.104&#8221;. This response is sent back through the servers to your computer.</p>

<p>After resolving the name, your computer now creates a data packet that will be sent to the computer at 72.14.204.104. The packet gets there by looking at your hosts route table and will hit your default gateway.</p>

<h1>The Technology</h1>

<p>IP over DNS is a method of encapsulating IP packets inside a DNS query. This essentially creates a VPN between a server and a client. In my case, I setup and configured the Iodine DNS server on my server located at RIT that I would use to route my traffic to the internet. Inside the tunnel exists the subnet of 192.168.0.0/27, with the server being at 192.168.0.1. My client connected and received IP address 192.168.0.2.</p>

<h1>The Problem</h1>

<p>Certain WLAN installations will include a guest SSID that non-controlled clients can associate to (In this scenario, I will use ExampleGuest, keeping the actual one I used anonymous). Often your traffic will get routed to a captive portal first, requiring you to enter credentials supplied by your organization. Until you do so, none of your traffic will reach it&#8217;s destination outside the LAN&#8230; UNLESS you discover a vulnerability, such as the one we are going to explore.</p>

<p>When I walked into the Example Corp site, I flipped open my trusty laptop and got to work. After associating with the ExampleGuest SSID, I was given the IP address 10.24.50.22/24 with gateway 10.24.50.1. I opened my web browser in attempt to get to &#8220;www.google.com&#8221;, and was immediately directed to the captive portal asking me to log in. Obviously I do not have credentials to this network, so I am at a dead end at this time.</p>

<p>Next I whipped out a terminal session, and did a lookup on &#8220;www.google.com&#8221;. Lo and behold the name was resolved to it&#8217;s external IP address. This means that DNS traffic was being allowed past the captive portal and out onto the network. If &#8220;www.google.com&#8221; resolved to something like &#8220;1.1.1.1&#8221; or an address in the 10.24.0.0/16 space, I know that the captive portal is grabbing all of my traffic. This would be the end of this experiment. However as I saw, this was not the case. External DNS queries were still being answered. Time to do some hacks.</p>

<h1>The Exploit</h1>

<p>Step 1) I need my Iodine client to be able to &#8220;query&#8221; my remote name server. I added a static route to my laptop that forced traffic to my server through the gateway given to me by the DHCP server. (ip route add 129.21.50.104 via 10.24.50.1)</p>

<p>Step 2) I need to establish my IPoDNS tunnel. (iodine -P mypasswordwenthere tunnel.grantcohoe.com) A successful connection gave me the IP address 192.168.0.2. I was then able to ping 192.168.0.1, which is the inside IP address of the tunnel).</p>

<p>Step 3) I need to change my default gateway to the server address inside the tunnel (ip route add default via 192.168.0.1).</p>

<p>And with that, all of my traffic is going to be encapsulated over the IP over DNS tunnel and sent to my server as DNS queries, this giving me unrestricted internet access bypassing the captive portal.</p>

<h1>The Defense</h1>

<p>This entire experiment would grind to a halt if DNS queries were not being handled externally. The network administrator should enable features necessary to either drop DNS requests or answer them with the captive portal IP address.</p>

<h1>The Conclusion</h1>

<p>End result: Unrestricted internet access over a wireless network that I have no credentials to.</p>

<p>Difficulty of setting this up: HIGH
Speed of tunneled internet: SLOW
Worth it for practical use: NOT AT ALL
Worth it for education: A LOT</p>

<p>This sort of trick can work on airplane and hotel wireless systems as well. Most sites do not think to have their captive portals capture DNS traffic in addition to regular IP traffic. As we can see here, it can be used against them.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Grant Cohoe</span></span>

      








  


<time datetime="2013-01-03T01:21:00-05:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2013</time>
    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cohoe.github.com/blog/2013/01/03/ip-over-dns-exploit/" data-via="grantcohoe" data-counturl="http://cohoe.github.com/blog/2013/01/03/ip-over-dns-exploit/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2013/01/03/dynamic-dual-home-linux-server/" title="Previous Post: Dynamic Dual-Home Linux Server">&laquo; Dynamic Dual-Home Linux Server</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2013/02/13/stanford-webauth-on-enterprise-linux/" title="Next Post: Stanford Webauth on Enterprise Linux">Stanford Webauth on Enterprise Linux &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul>
    
      <li><a class='category' href='/blog/categories/projects/'>Projects</a></li>
    
      <li><a class='category' href='/blog/categories/guides/'>Guides</a></li>
    
      <li><a class='category' href='/blog/categories/misc/'>Misc</a></li>
    
      <li><a class='category' href='/blog/categories/musings/'>Musings</a></li>
    
      <li><a class='category' href='/blog/categories/presentations/'>Presentations</a></li>
    
      <li><a class='category' href='/blog/categories/events/'>Events</a></li>
    
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/10/barcamp-tour-2013/">Barcamp Tour 2013</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/02/infrastructure-security-considerations/">Infrastructure Security Considerations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/05/cloudbell-cloud-based-doorbell-service/">Cloudbell: Cloud-based doorbell service</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/24/starrs-installation-guide/">STARRS Installation Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/backups-for-photo-majors/">Backups for Photo Majors</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Grant Cohoe -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
