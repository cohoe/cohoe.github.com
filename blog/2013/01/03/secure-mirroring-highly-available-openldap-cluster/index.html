
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Secure Mirroring Highly-Available OpenLDAP Cluster - Grant Cohoe</title>
  <meta name="author" content="Grant Cohoe">

  
  <meta name="description" content="Background My organization stores user information in an OpenLDAP directory server. This includes contact information, shell preferences, iButton IDs &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cohoe.github.com/blog/2013/01/03/secure-mirroring-highly-available-openldap-cluster/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/cohoe.css" type="text/css" rel="stylesheet">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Grant Cohoe" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37491721-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Grant Cohoe</a></h1>
  
    <h2>Cloud plumber, bit wrangler, solution engineer.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cohoe.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/skills">Skills</a></li>
  <li><a href="/about">About</a></li>
 <!-- <li><a href="/blog/archives">Archives</a></li>-->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Secure Mirroring Highly-Available OpenLDAP Cluster</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-01-03T00:41:00-05:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Background</h1>

<p>My organization stores user information in an OpenLDAP directory server. This includes contact information, shell preferences, iButton IDs, etc. The directory server does not store the users password and relies on a Kerberos KDC to provide authentication via SASL. This is a widely supported configuration and is popular because you can achieve SSO (Single Sign-On) and keep passwords out of your directory. Our shell access machines are configured to do LDAP authentication of users which basically instructs PAM to do a bind to the LDAP server using the credentials provided by the user. If the bind is successful, the user logs in. If not, well sucks to be them. Before this project we had a single server handling the directory running CentOS 5.8/OpenLDAP 2.3. If this server went poof, then all userdata is lost and no one could log into any other servers (or websites if configured with Stanford Webauth. See the guide for more on this). Obviously this is a problem that needed correcting.</p>

<h1>Technology</h1>

<h2>LDAP Synchronization</h2>

<p>OpenLDAP 2.4 introduced a method of replication called &#8220;mirrormode&#8221;. This allows you to use their already existing syncrepl protocol to synchronize data between multiple servers. Previously (OpenLDAP &lt;= 2.3) only allowed you to do a master-slave style of replication where the slaves are read-only and would be unwilling to perform changes. Obviously this has some limitations in that if your master (or &#8220;provider&#8221; in OpenLDAP-ish) were to die, then your users cannot do any changes until you get it back online. Using MirrorMode, you can create an &#8220;N-way Multi-Master&#8221; topology that allows all servers to be read/write and instantly replicate their changes to the others.</p>

<h2>High Availability</h2>

<p>To enable users to have LDAP access even if one of the servers dies, we need a way to keep the packets flowing and automatically failover to the secondary servers. Linux has a package called &#8220;Heartbeat&#8221; that allows this sort of functionality. If you are familiar with Cisco HSRP or the open-source VRRP, it works the same way. Server A is assigned an IP address (lets say 10.0.0.1) and Server B is assigned a different address (lets say 10.0.0.2). Heartbeat is configured to provide a third IP address (10.0.0.3) that will always be available between the two. On the primary server, an ethernet alias is created with the virtualized IP address. Periodic heartbeats (keep-alive packets) are sent out to the other servers to indicate &#8220;I&#8217;m still here!&#8221;. Should these messages start disappearing (like when the server dies), the secondary will notice the lack of updates and automatically create a similar alias interface on itself and assign that virtualized IP. This allows you to give your clients one host, but have it seemlessly float between several real ones.</p>

<h2>SASL Authentication</h2>

<p>The easy way of configuring MirrorMode requires you to store your replication DN&#8217;s credentials in plaintext in the config file. Obviously this is not very secure since you are storing passwords in plaintext. As such we can use the hosts Kerberos principal to bind to the LDAP server as the replication DN and perform all of the tasks we need to do. This is much better than plaintext!</p>

<h2>SSL</h2>

<p>Since we like being secure, we should really be using LDAPS (LDAP + SSL) to get our data. We will be setting this up too using our PKI. We will save this for the end since we want to ensure that our core functionality actually works first.</p>

<h1>New Servers</h1>

<p>I spun up two new machines, lets call them &#8220;warlock.example.com&#8221; and &#8220;ldap2.example.com&#8221;. Each of them runs my favorite Scientific Linux 6.2 but with OpenLDAP 2.4. You cannot do MirrorMode between 2.3 and 2.4.</p>

<p><img src="/sites/default/files/styles/medium/public/ldaptopo.PNG" alt="" title="" class="image-medium" /></p>

<h1>Configuration</h1>

<h2>Packages</h2>

<p>First we need to install the required packages for all of this nonsense to work.</p>

<ul>
<li>openldap (LDAP libraries)</li>
<li>openldap-servers (Server)</li>
<li>openldap-clients (Client utilities)</li>
<li>cyrus-sasl (SASL daemon)</li>
<li>cyrus-sasl-ldap (LDAP authentication for SASL)</li>
<li>cyrus-sasl-gssapi (Kerberos authentication for SASL)</li>
<li>krb5-workstation (Kerberos client utilities)</li>
<li>heartbeat (Failover)</li>
</ul>


<p>If you are coming off of a fresh minimal install, you might want to install openssh-clients and vim as well. Some packages may not be included in your base distribution and may need other repositories (EPEL, etc)</p>

<h2>Kerberos Keytabs</h2>

<p>Each host needs its own set of host/ and ldap/ principals as well as a shared one for the virtualized address. In the end, you need a keytab with the following principals:</p>

<ul>
<li>host/ldap1.example.com@EXAMPLE.COM</li>
<li>ldap/ldap1.example.com@EXAMPLE.COM</li>
<li>host/ldap.example.com@EXAMPLE.COM</li>
<li>ldap/ldap.example.com@EXAMPLE.COM</li>
</ul>


<p>WARNING: Each time you write a -randkey&#8217;d principal to a keytab, it&#8217;s KVNO (Key Version Number) is increased, thus invalidating all previous written principals. You need to merge the shared principals into each hosts keytab. See my guide on Kerberos Utilities for information on doing this.</p>

<p>Put this file at /etc/krb5.keytab and set an ACL on it such that the LDAP user can read it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap1 ~]# chmod 640 /etc/krb5.keytab 
</span><span class='line'>[root@ldap1 ~]# setfacl -m u:ldap:r /etc/krb5.keytab 
</span><span class='line'>[root@ldap1 ~]# </span></code></pre></td></tr></table></div></figure>


<p>If you see something like &#8220;kerberos error 13&#8221; or &#8220;get_sec_context: 13&#8221; it means that someone cannot read the keytab, usually the LDAP server. Fix it.</p>

<h2>NTP</h2>

<p>Kerberos and the OpenLDAP synchronization require synchronized clocks. If you aren&#8217;t already set up for this, follow my guide for setting up NTP on a system before continuing.</p>

<h2>SASL</h2>

<p>You need saslauthd to be running on both LDAP servers. If you do not already have this set up, follow my guide for SASL Authentication before continuing.</p>

<h2>Logging</h2>

<p>We will be using Syslog and Logrotate to manage the logfiles for the LDAP daemon (slapd). By default it will spit out to local4. This is configurable depending on your system, but for me I am leaving it as the default. Add an entry to your <code>rsyslog</code> config file (usually <code>/etc/rsyslog.conf</code>) for <code>slapd</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>local4.*                /var/log/slapd.log</span></code></pre></td></tr></table></div></figure>


<p>Now unless we tell <code>logrotate</code> to rotate this file, it will get infinitely large and cause you lots of headaches. I created a config file to automatically rotate this log according the the system defaults. This was done at <code>/etc/logrotate.d/slapd</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/var/log/slapd.log {
</span><span class='line'>    missingok
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Then restart <code>rsyslog</code>. Logrotate runs on a cron job and is not required to be restarted.</p>

<h2>Data Directory</h2>

<p>Since I am grabbing the data from my old LDAP server, I will not be setting up a new data directory. On the old server and on the new master, the data directory is <code>/var/lib/ldap/</code>. I simply scp&#8217;d all of the contents from the old server over to this directory. If you do this, I recommend stopping the old server for a moment to ensure that there are no changes occurring while you work. After scp-ing everything, make sure to chown everything to the LDAP user. I also recommend running <code>slapindex</code> to ensure that all data gets reindexed.</p>

<p><code>Client Library Configuration</code>
Now to make it convenient to test your new configuration, edit your <code>/etc/openldap/ldap.conf</code> to change the URI and add the certificate settings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BASE            dc=example,dc=com
</span><span class='line'>URI             ldaps://ldap.example.com
</span><span class='line'>TLS_CACERT      /etc/pki/tls/example-ca.crt
</span><span class='line'>TLS_REQCERT     allow</span></code></pre></td></tr></table></div></figure>


<p>When configuring this file on the servers, TLS_REQCERT must be set to ALLOW since we are doing Syncrepl over LDAPS. Obviously since we are using a shared certificate for ldap.example.com, it will not match the hostname of the server and will fail. On all of your clients, they should certainly &#8220;demand&#8221; the certificate. But in this instance that prevents us from accomplishing Syncrepl over LDAPS.</p>

<h2>Certificates for LDAPS</h2>

<p>Since people want to be secure, OpenLDAP has the ability to do sessions inside of TLS tunnels. This works the same way HTTPS traffic does. To do this you need to have the ability to generate SSL certificates based on a given CA. This procedure varies from organization to organization. Regardless of your method, the hostname you chose is critical as this will be the name that is verified. In this setup, we are creating a host called &#8220;ldap.example.com&#8221; that all LDAP clients will be configured to use. As such the same SSL certificate for both hosts will be generated for &#8220;ldap.example.com&#8221; and placed on each server.</p>

<p>I placed the public certificate at <code>/etc/pki/tls/certs/slapd.pem</code>, the secret key in <code>/etc/pki/tls/private/slapd.pem</code>, and my CA certificate at <code>/etc/pki/tls/example-ca.crt</code>. After obtaining my files, I verify them to make sure that they will actually work:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap1 ~]# openssl verify -CAfile /etc/pki/tls/example-ca.crt /etc/pki/tls/certs/slapd.pem
</span><span class='line'>/etc/pki/tls/certs/slapd.pem: OK
</span><span class='line'>[root@ldap1 ~]# </span></code></pre></td></tr></table></div></figure>


<p>You need to allow the LDAP account to read the private certificate:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap1 ~]# setfacl -m u:ldap:r /etc/pki/tls/private/slapd.pem</span></code></pre></td></tr></table></div></figure>


<h2>Server Configuration</h2>

<p>If you are using a previous server configuration, just scp the entire <code>/etc/openldap</code> code over to the new servers. Make sure you blow away any files or directories that may have been added for you before you copy. If you are not, you might need to do a bit of setup. OpenLDAP 2.4 uses a new method of configuration called &#8220;cn=config&#8221;, which stores the configuration data in the LDAP database. However since this is not fully supported by most clients, I am still using the config file. For setting up a fresh install, see one of my other articles on this. (Still in progress at the time of this writing)</p>

<p>The following directives will need to be placed in your slapd.conf for the SSL certificates:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>TLSCertificateFile /etc/pki/tls/certs/slapd.pem
</span><span class='line'>TLSCertificateKeyFile /etc/pki/tls/private/slapd.pem
</span><span class='line'>TLSCACertificateFile /etc/pki/tls/example-ca.crt</span></code></pre></td></tr></table></div></figure>


<p>Depending on your system, you may need to configure the daemon to run on ldaps://. On Red-Hat based systems this is in <code>/etc/sysconfig/ldap</code>.</p>

<p>You need to add two things to your configuration for Syncrepl to function. First to your <code>slapd.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Syncrepl ServerID
</span><span class='line'>serverID 001
</span><span class='line'>
</span><span class='line'># Syncrepl configuration for mirroring instant replication between another 
</span><span class='line'># server. The binddn should be the host/ principal of this server 
</span><span class='line'># stored in the Kerberos keytab
</span><span class='line'>syncrepl rid=001
</span><span class='line'>provider=ldaps://ldap2.example.com
</span><span class='line'>type=refreshAndPersist
</span><span class='line'>retry="5 5 300 +"
</span><span class='line'>searchbase="dc=example,dc=com"
</span><span class='line'>attrs="*,+"
</span><span class='line'>bindmethod=sasl
</span><span class='line'>binddn="cn=ldap1,ou=hosts,dc=example,dc=com"
</span><span class='line'>mirrormode TRUE</span></code></pre></td></tr></table></div></figure>


<p>The serverID value must uniquely identify the server. Make sure you change it when inserting the configuration onto the secondary server. Likewise change the Syncrepl RID as well for the same reason.</p>

<p>Secondly you need need to allow the replication binddn full read access to all objects. This should go in your ACL file (which could be your slapd.conf, but shouldnt be).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>access to *
</span><span class='line'>        by dn.exact="cn=ldap1,ou=hosts,dc=example,dc=com" read
</span><span class='line'>        by dn.exact="cn=ldap2,ou=hosts,dc=example,dc=com" read</span></code></pre></td></tr></table></div></figure>


<p>WARNING: If you do not have an existing ACL setup, doing just these entries will prevent anything else from doing anything with your server. These directives are meant to be ADDED to an existing ACL.</p>

<p>You should be all set and ready to start the server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap1 ~]# service slapd start
</span><span class='line'>Starting slapd:                                            [  OK  ] 
</span><span class='line'>[root@ldap1 ~]# </span></code></pre></td></tr></table></div></figure>


<p>Make sure that when you do your SASL bind, the server reports your DN correctly. To verify this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ldap1 ~ # su ldap -s /bin/bash
</span><span class='line'>bash-4.1$ kinit -k -t /etc/krb5.keytab host/ldap1.example.com
</span><span class='line'>bash-4.1$ ldapwhoami -Q
</span><span class='line'>dn:cn=ldap1,ou=hosts,dc=example,dc=com
</span><span class='line'>bash-4.1$</span></code></pre></td></tr></table></div></figure>


<p>That DN is the one that should be in your ACL and have read access to everything.</p>

<p>Since the LDAP user will always need this principal, I recommend adding a cronjob to keep the ticket alive. I wrote a script that will renew your ticket and fix an SELinux permissioning problem as well. You can get it <a href="http://archive.grantcohoe.com/projects/ldap/slaprenew">here</a>. Just throw it into your <code>/usr/local/sbin/</code> directory. There are better ways of doing this, but this one works just as well.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0 */2 * * * /usr/local/sbin/slaprenew</span></code></pre></td></tr></table></div></figure>


<h2>Firewall</h2>

<p>Dont forget to open up ports 389 and 636 for LDAP and LDAPSSL!</p>

<h2>Searching</h2>

<p>After configuring both the master and the secondary servers, we now need to get the data initially replicated across your secondaries. Assuming you did like me and copied the data directory from an old server, your master is the only one that has real data. Start the service on this machine. If all went according to plan, you should be able to search for an object to verify that it works.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap1 ~]# kinit user
</span><span class='line'>Password for user@EXAMPLE.COM:
</span><span class='line'>[root@ldap1 ~]# ldapsearch -h localhost uid=user uidNumber -Q -LLL
</span><span class='line'>dn: uid=user,ou=users,dc=example,dc=com
</span><span class='line'>uidNumber: 10046
</span><span class='line'>
</span><span class='line'>[root@ldap1 ~]#</span></code></pre></td></tr></table></div></figure>


<p>If you get errors, increase the debug level (-d 1) and work out any issues.</p>

<h2>Replication</h2>

<p>After doing a kinit as the LDAP user described above (host/ldap2.example.com), start the LDAP server on the secondary. If you tail the slapd log file, you should start seeing replication events occurring really fast. This is the server loading its data from the provider as specified in slapd.conf. Once it is done, try searching the server in a similar fashion as above.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@ldap2 ~]# tail /var/log/slapd.log
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 be_search (0)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 uid=user,ou=Users,dc=example,dc=com
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 be_add uid=user,ou=Users,dc=example,dc=com (0)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 LDAP_RES_SEARCH_ENTRY(LDAP_SYNC_ADD)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 inserted UUID 84ba3544-5be8-102b-9a32-4dfcdb785320
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 be_search (0)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 uid=user,ou=Users,dc=example,dc=com
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 be_add uid=user,ou=Users,dc=example,dc=com (0)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 LDAP_RES_SEARCH_ENTRY(LDAP_SYNC_ADD)
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 inserted UUID 84c04164-5be8-102b-9a33-4dfcdb785320
</span><span class='line'>slapd[15759]: syncrepl_entry: rid=001 be_search (0)</span></code></pre></td></tr></table></div></figure>


<h2>Heartbeat</h2>

<p>Heartbeat provides failover for configured resources between several Linux systems. In this case we are going to provide high-availability of an alias IP address (10.0.0.3) which we will distribute to clients as the LDAP server (ldap.example.com). Heartbeat configuration is very simple and only requires three files:</p>

<p><code>/etc/ha.d/haresources</code> contains the resources that we will be failing over. It should be the same on both servers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ldap1.example.com IPaddr::10.0.0.3/24/eth0:1/10.0.0.255</span></code></pre></td></tr></table></div></figure>


<p>The reason the name of the host above is not &#8220;ldap.example.com&#8221; is because the entry must be a node listed in the configuration file (below).</p>

<p><code>/etc/ha.d/authkeys</code> contains a shared secret used to secure the heartbeat messages. This is to ensure that someone doesnt just throw up a server and claim to be a part of your cluster.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth 1
</span><span class='line'>1 md5 mysupersecretpassword</span></code></pre></td></tr></table></div></figure>


<p>Make sure to chmod it to something not world-readable (600 is recommend).</p>

<p>Finally, <code>/etc/ha.d/ha.cf</code> is the Heartbeat configuration file. It should contain entries for each server in your cluster, timers, and log files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mcast           eth0 225.0.0.1 694 1 0
</span><span class='line'>auto_failback   on
</span><span class='line'>keepalive 1
</span><span class='line'>deadtime 5
</span><span class='line'>debugfile       /var/log/ha-debug.log
</span><span class='line'>logfile         /var/log/ha.log
</span><span class='line'>logfacility     local0
</span><span class='line'>udp             eth0
</span><span class='line'>node            ldap1.example.com
</span><span class='line'>node            ldap2.example.com</span></code></pre></td></tr></table></div></figure>


<p>After all this is set, start the heartbeat service. After a bit you should see another ethernet interface show up on your primary. To test failover, unplug one of the machines and see what happens!</p>

<h2>DNS Hack</h2>

<p>A side affect of having the LDAP server respond on the shared IP address is that it gets confused about its hostname. As such you need to edit your <code>/etc/hosts</code> file to point the ldap.example.com name to each of the actual host IP addresses. In this example, ldap1 is 10.0.0.1 and ldap2 is 10.0.0.2. You should modify your hosts file to include:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10.0.0.1 ldap.example.com ldap
</span><span class='line'>10.0.0.2 ldap.example.com ldap</span></code></pre></td></tr></table></div></figure>


<p>The first entry should be the address of the local system (10.0.0.2 should be the first in the case of ldap2).</p>

<p>Your DNS server should be able to do forward and reverse lookups for <code>ldap.example.com</code> going to 10.0.0.3 (the highly available address).</p>

<p>If you are having issues binding between the servers or binding from clients, it is usually due to DNS problems.</p>

<h1>Testing</h1>

<p>If all went according to plan, you should be able to see Sync messages in your slapd log file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>slapd[11059]: slapd starting
</span><span class='line'>slapd[11059]: do_syncrep2: rid=002 LDAP_RES_INTERMEDIATE - REFRESH_DELETE</span></code></pre></td></tr></table></div></figure>


<p>Likewise if you log into a client machine (in my case, I made this the KDC) you should be able to search at only the ldap.example.com host. The others will return errors.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kdc ~]# ldapsearch -Q -LLL uid=user displayName -h ldap.example.com
</span><span class='line'>dn: uid=user,ou=users,dc=example,dc=com
</span><span class='line'>displayName: Firstname Lastname (user)
</span><span class='line'>
</span><span class='line'>[root@kdc ~]# ldapsearch -Q -LLL uid=user displayName -h ldap1.example.com
</span><span class='line'>ldap_sasl_interactive_bind_s: Invalid credentials (49)
</span><span class='line'>        additional info: SASL(-13): authentication failure: GSSAPI Failure: gss_accept_sec_context
</span><span class='line'>[root@kdc ~]# ldapsearch -Q -LLL uid=user displayName -h ldap2.example.com
</span><span class='line'>ldap_sasl_interactive_bind_s: Invalid credentials (49)
</span><span class='line'>        additional info: SASL(-13): authentication failure: GSSAPI Failure: gss_accept_sec_context
</span><span class='line'>[root@kdc ~]# </span></code></pre></td></tr></table></div></figure>


<p>The reason is that the client has a different view of what the server&#8217;s hostname is. This difference causes SASL to freak out and not allow you to bind.</p>

<h1>Errors</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@kdc ~]# ldapsearch -h ldap.example.com uid=user
</span><span class='line'>SASL/GSSAPI authentication started
</span><span class='line'>ldap_sasl_interactive_bind_s: Invalid credentials (49)
</span><span class='line'>        additional info: SASL(-13): authentication failure: GSSAPI Failure: gss_accept_sec_context
</span><span class='line'>[root@kdc ~]#</span></code></pre></td></tr></table></div></figure>


<p>On the server reveals the error of:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>slapd[9888]: GSSAPI Error: Unspecified GSS failure.  Minor code may provide more information (Wrong principal in request)
</span><span class='line'>slapd[9888]: text=SASL(-13): authentication failure: GSSAPI Failure: gss_accept_sec_context</span></code></pre></td></tr></table></div></figure>


<p>This means your DNS is not hacked or functional. Fix it according to the instructions</p>

<p>The LDAP log says:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>slapd[1901]: do_syncrepl: rid=005 rc -2 retrying
</span><span class='line'>slapd[1901]: slap_client_connect: URI=ldap://ldap2.example.com ldap_sasl_interactive_bind_s failed (-2)</span></code></pre></td></tr></table></div></figure>


<p>and <code>/var/log/messages</code> contains:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GSSAPI Error: Unspecified GSS failure.  Minor code may provide more information (Credentials cache permissions incorrect)</span></code></pre></td></tr></table></div></figure>


<p>You need to change the SELinux context of your KRB5CC file (default is <code>/tmp/krb5cc_$UIDOFLDAPUSER</code> on Scientific Linux) to something the slapd process can read. Since every time you re-initialize the ticket you risk defaulting the permissions, I recommend using my script in your cronjob from above. If someone finds a better way to do this, please let me know!</p>

<p>If after enabling SSL on your client you receive (using -d 1):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>TLS: can't connect: TLS error -5938:Encountered end of file.</span></code></pre></td></tr></table></div></figure>


<p>Check your certificate files on the SERVER. Odds are you have an incorrect path.</p>

<h1>Summary</h1>

<p>You now have two independent LDAP servers running OpenLDAP 2.4 and synchronizing data between them. They are intended to listen on a Heartbeat-ed service IP address that will always be available even if one of the servers dies. You can also do SASL binds to each server to avoid having passwords stored in your configuration files.</p>

<p>If after reading this you feel there is something that can be improved or isnt clear, feel free to contact me! Also you can grab sample configuration files that I used at <a href="http://archive.grantcohoe.com/projects/ldap">http://archive.grantcohoe.com/projects/ldap</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Grant Cohoe</span></span>

      








  


<time datetime="2013-01-03T00:41:00-05:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2013</time>
    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cohoe.github.com/blog/2013/01/03/secure-mirroring-highly-available-openldap-cluster/" data-via="grantcohoe" data-counturl="http://cohoe.github.com/blog/2013/01/03/secure-mirroring-highly-available-openldap-cluster/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2013/01/03/kerberos-utilities/" title="Previous Post: Kerberos Utilities">&laquo; Kerberos Utilities</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2013/01/03/facebook-friend-guidelines/" title="Next Post: Facebook Friend Guidelines">Facebook Friend Guidelines &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul>
    
      <li><a class='category' href='/blog/categories/projects/'>Projects</a></li>
    
      <li><a class='category' href='/blog/categories/guides/'>Guides</a></li>
    
      <li><a class='category' href='/blog/categories/misc/'>Misc</a></li>
    
      <li><a class='category' href='/blog/categories/musings/'>Musings</a></li>
    
      <li><a class='category' href='/blog/categories/presentations/'>Presentations</a></li>
    
      <li><a class='category' href='/blog/categories/events/'>Events</a></li>
    
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/10/barcamp-tour-2013/">Barcamp Tour 2013</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/02/infrastructure-security-considerations/">Infrastructure Security Considerations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/05/cloudbell-cloud-based-doorbell-service/">Cloudbell: Cloud-based doorbell service</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/24/starrs-installation-guide/">STARRS Installation Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/backups-for-photo-majors/">Backups for Photo Majors</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Grant Cohoe -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
